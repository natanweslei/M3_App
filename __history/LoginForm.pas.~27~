unit LoginForm;

interface

uses
  Windows,
  Messages,
  SysUtils,
  Variants,
  Classes,
  Graphics,
  Controls,
  Forms,
  uniGUITypes,
  uniGUIAbstractClasses,
  uniGUIClasses,
  uniGUIRegClasses,
  uniGUIForm,
  uniGUIBaseClasses,
  uniImage,
  Vcl.Imaging.pngimage,
  uniEdit,
  uniButton,
  ConexaoPostgreSQL,
  FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param,
  FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf,
  FireDAC.Stan.Async, FireDAC.DApt, Data.DB, FireDAC.Comp.DataSet,
  FireDAC.Comp.Client;

type
  TUniLoginForm1 = class(TUniLoginForm)
    UniImage1: TUniImage;
    edtUsuario: TUniEdit;
    edtSenha: TUniEdit;
    btnLogin: TUniButton;
    procedure btnLoginClick(Sender: TObject);
    procedure edtSenhaKeyPress(Sender: TObject; var Key: Char);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

function UniLoginForm1: TUniLoginForm1;

implementation

{$R *.dfm}

uses
  uniGUIVars,
  MainModule,
  uniGUIApplication;

function UniLoginForm1: TUniLoginForm1;
begin
  Result := TUniLoginForm1(UniMainModule.GetFormInstance(TUniLoginForm1));
end;

procedure TUniLoginForm1.edtSenhaKeyPress(Sender: TObject; var Key: Char);
begin
  if key = #13 then
    btnLoginClick(nil);
end;

procedure TUniLoginForm1.btnLoginClick(Sender: TObject);
var
  qryLogin: TFDQuery;
begin
  if Trim(edtUsuario.Text) = EmptyStr then
  begin
    ShowMessage('Informe o usuário!');
    Exit;
  end;

  if Trim(edtSenha.Text) = EmptyStr then
  begin
    ShowMessage('Informe a senha!');
    Exit;
  end;

  qryLogin := TFDQuery.Create(nil);
  qryLogin.Connection := ConexaoPostgreSQL.FConexao;

  qryLogin.Close;
  qryLogin.SQL.Clear;
  qryLogin.SQL.Add('select FUNCIONARIO_ID');
  qryLogin.SQL.Add('from FUNCIONARIO');
  qryLogin.SQL.Add('where USUARIO = :USUARIO and SENHA = :SENHA');

  qryLogin.ParamByName('USUARIO').Value := edtUsuario.Text;
  qryLogin.ParamByName('SENHA').Value := edtSenha.Text;

  qryLogin.Open;

  if qryLogin.RecordCount = 0 then
  begin
    ShowMessage('Usuário ou senha incorreto!');
    Exit;
  end;

  UniMainModule.UserId := qryLogin.FieldByName('FUNCIONARIO_ID').AsInteger;

  qryLogin.Free;

  ModalResult := mrOk;
end;

initialization
  RegisterAppFormClass(TUniLoginForm1);

end.
